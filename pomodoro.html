<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Timer</title>
    <link rel="stylesheet" href="styles.css?v=3.1">
</head>

<body>
    <div class="container pomodoro">
        <div class="header-with-settings">
            <h1>üçÖ Pomodoro Timer</h1>
            <button id="settingsBtn" class="settings-btn" title="Settings">‚öôÔ∏è</button>
        </div>

        <div class="mode-selector">
            <button class="mode-btn active" data-mode="pomodoro">Pomodoro</button>
            <button class="mode-btn" data-mode="short">Short Break</button>
            <button class="mode-btn" data-mode="long">Long Break</button>
        </div>

        <div class="timer-display" id="timer">25:00</div>
        <div class="timer-label" id="label">Focus Time</div>

        <div class="controls">
            <button class="primary" id="startBtn">Start</button>
            <button id="resetBtn">Reset</button>
            <button id="endEarlyBtn" class="end-early-btn" style="display: none;">End Early</button>
        </div>

        <div class="tasks-section">
            <div class="tasks-title">Today's Focus Tasks</div>
            <div class="task-list">
                <div class="task-item" draggable="true" data-index="0">
                    <span class="drag-handle">‚ãÆ‚ãÆ</span>
                    <input type="checkbox" class="task-checkbox" id="checkbox1">
                    <input type="text" class="task-input" id="task1" placeholder="Task 1" maxlength="60">
                </div>
                <div class="task-item" draggable="true" data-index="1">
                    <span class="drag-handle">‚ãÆ‚ãÆ</span>
                    <input type="checkbox" class="task-checkbox" id="checkbox2">
                    <input type="text" class="task-input" id="task2" placeholder="Task 2" maxlength="60">
                </div>
                <div class="task-item" draggable="true" data-index="2">
                    <span class="drag-handle">‚ãÆ‚ãÆ</span>
                    <input type="checkbox" class="task-checkbox" id="checkbox3">
                    <input type="text" class="task-input" id="task3" placeholder="Task 3" maxlength="60">
                </div>
                <div class="task-item task-item-secondary" draggable="true" data-index="3">
                    <span class="drag-handle">‚ãÆ‚ãÆ</span>
                    <input type="checkbox" class="task-checkbox" id="checkbox4">
                    <input type="text" class="task-input task-input-secondary" id="task4" placeholder="Task 4"
                        maxlength="60">
                </div>
                <div class="task-item task-item-secondary" draggable="true" data-index="4">
                    <span class="drag-handle">‚ãÆ‚ãÆ</span>
                    <input type="checkbox" class="task-checkbox" id="checkbox5">
                    <input type="text" class="task-input task-input-secondary" id="task5" placeholder="Task 5"
                        maxlength="60">
                </div>
                <div class="task-item task-item-secondary" draggable="true" data-index="5">
                    <span class="drag-handle">‚ãÆ‚ãÆ</span>
                    <input type="checkbox" class="task-checkbox" id="checkbox6">
                    <input type="text" class="task-input task-input-secondary" id="task6" placeholder="Task 6"
                        maxlength="60">
                </div>
            </div>
        </div>

        <div class="stats">
            <div class="stats-item">
                <span class="stats-value" id="pomodoroCount">0</span>
                <span>Pomodoros</span>
            </div>
            <div class="stats-item">
                <span class="stats-value" id="totalTime">0</span>
                <span>Minutes</span>
            </div>
            <button id="resetStatsBtn" class="reset-stats-btn" title="Reset statistics">Reset Stats</button>
        </div>

        <a href="index.html" class="back-link">‚Üê Back to Home</a>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Timer Settings</h2>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="setting-item">
                    <label for="pomodoroDuration">Pomodoro Duration (minutes):</label>
                    <input type="number" id="pomodoroDuration" min="1" max="60" value="25">
                </div>
                <div class="setting-item">
                    <label for="shortBreakDuration">Short Break Duration (minutes):</label>
                    <input type="number" id="shortBreakDuration" min="1" max="30" value="5">
                </div>
                <div class="setting-item">
                    <label for="longBreakDuration">Long Break Duration (minutes):</label>
                    <input type="number" id="longBreakDuration" min="1" max="60" value="15">
                </div>
            </div>
            <div class="modal-footer">
                <button id="saveSettings" class="primary">Save Settings</button>
                <button id="cancelSettings">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Timer configuration (in minutes) - will be loaded from localStorage
        let TIMER_MODES = {
            pomodoro: { duration: 25, label: 'Focus Time', useTask: true },
            short: { duration: 5, label: 'Short Break', useTask: false },
            long: { duration: 15, label: 'Long Break', useTask: false }
        };

        // State
        let currentMode = 'pomodoro';
        let timeLeft = TIMER_MODES[currentMode].duration * 60; // in seconds
        let isRunning = false;
        let timerInterval = null;
        let sessionStartTime = null; // Track when session started
        let pomodoroCount = 0;
        let totalMinutes = 0;
        let tasks = ['', '', '', '', '', ''];
        let taskChecked = [false, false, false, false, false, false];

        // DOM elements
        const timerDisplay = document.getElementById('timer');
        const labelDisplay = document.getElementById('label');
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');
        const endEarlyBtn = document.getElementById('endEarlyBtn');
        const resetStatsBtn = document.getElementById('resetStatsBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const closeModal = document.getElementById('closeModal');
        const saveSettings = document.getElementById('saveSettings');
        const cancelSettings = document.getElementById('cancelSettings');
        const pomodoroDurationInput = document.getElementById('pomodoroDuration');
        const shortBreakDurationInput = document.getElementById('shortBreakDuration');
        const longBreakDurationInput = document.getElementById('longBreakDuration');
        const modeButtons = document.querySelectorAll('.mode-btn');
        const pomodoroCountDisplay = document.getElementById('pomodoroCount');
        const totalTimeDisplay = document.getElementById('totalTime');
        const taskInputs = [
            document.getElementById('task1'),
            document.getElementById('task2'),
            document.getElementById('task3'),
            document.getElementById('task4'),
            document.getElementById('task5'),
            document.getElementById('task6')
        ];
        const taskCheckboxes = [
            document.getElementById('checkbox1'),
            document.getElementById('checkbox2'),
            document.getElementById('checkbox3'),
            document.getElementById('checkbox4'),
            document.getElementById('checkbox5'),
            document.getElementById('checkbox6')
        ];

        // Load timer settings from localStorage
        function loadTimerSettings() {
            const saved = localStorage.getItem('timerSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                TIMER_MODES.pomodoro.duration = settings.pomodoro || 25;
                TIMER_MODES.short.duration = settings.short || 5;
                TIMER_MODES.long.duration = settings.long || 15;
            }
        }

        // Save timer settings to localStorage
        function saveTimerSettings() {
            localStorage.setItem('timerSettings', JSON.stringify({
                pomodoro: TIMER_MODES.pomodoro.duration,
                short: TIMER_MODES.short.duration,
                long: TIMER_MODES.long.duration
            }));
        }

        // Load saved stats from localStorage
        function loadStats() {
            const saved = localStorage.getItem('pomodoroStats');
            if (saved) {
                const stats = JSON.parse(saved);
                pomodoroCount = stats.pomodoroCount || 0;
                totalMinutes = stats.totalMinutes || 0;
                tasks = stats.tasks || ['', '', '', '', '', ''];
                taskChecked = stats.taskChecked || [false, false, false, false, false, false];
                updateStatsDisplay();
                updateTasksDisplay();
                updateTaskHighlight();
            }
        }

        // Save stats to localStorage
        function saveStats() {
            localStorage.setItem('pomodoroStats', JSON.stringify({
                pomodoroCount,
                totalMinutes,
                tasks,
                taskChecked
            }));
        }

        // Update tasks display
        function updateTasksDisplay() {
            taskInputs.forEach((input, index) => {
                input.value = tasks[index] || '';
                taskCheckboxes[index].checked = taskChecked[index];
            });
            updateTaskHighlight();
        }

        // Update task highlighting
        function updateTaskHighlight() {
            const taskItems = document.querySelectorAll('.task-item');

            // Remove all highlights first
            taskItems.forEach(item => {
                item.classList.remove('task-highlight');
            });

            // Find first unchecked task with content and highlight it
            for (let i = 0; i < taskChecked.length; i++) {
                if (!taskChecked[i] && tasks[i].trim()) {
                    taskItems[i].classList.add('task-highlight');
                    break;
                }
            }

            // Update checked styling
            taskItems.forEach((item, index) => {
                if (taskChecked[index]) {
                    item.classList.add('checked');
                } else {
                    item.classList.remove('checked');
                }
            });
        }

        // Save tasks
        function saveTasks() {
            taskInputs.forEach((input, index) => {
                tasks[index] = input.value;
            });
            saveStats();
            updateDisplay(); // Update label when task changes
        }

        // Format time as MM:SS
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Update timer display
        function updateDisplay() {
            timerDisplay.textContent = formatTime(timeLeft);

            // Find first unchecked task
            let activeTaskIndex = taskChecked.findIndex((checked, i) => !checked && tasks[i].trim());

            let label = TIMER_MODES[currentMode].label;
            if (TIMER_MODES[currentMode].useTask && activeTaskIndex !== -1) {
                labelDisplay.innerHTML = `<span class="task-highlight">${tasks[activeTaskIndex]}</span> Focus Time`;
            } else {
                labelDisplay.textContent = label;
            }

            document.title = `${formatTime(timeLeft)} - Pomodoro Timer`;
        }

        // Update stats display
        function updateStatsDisplay() {
            pomodoroCountDisplay.textContent = pomodoroCount;
            totalTimeDisplay.textContent = totalMinutes;
        }

        // Start/Pause timer
        function toggleTimer() {
            if (isRunning) {
                pauseTimer();
            } else {
                startTimer();
            }
        }

        // Start timer
        function startTimer() {
            isRunning = true;
            startBtn.textContent = 'Pause';
            sessionStartTime = Date.now(); // Record start time
            endEarlyBtn.style.display = 'inline-block'; // Show end early button

            timerInterval = setInterval(() => {
                if (timeLeft > 0) {
                    timeLeft--;
                    updateDisplay();
                } else {
                    completeTimer();
                }
            }, 1000);
        }

        // Pause timer
        function pauseTimer() {
            isRunning = false;
            startBtn.textContent = 'Resume';
            clearInterval(timerInterval);
            endEarlyBtn.style.display = 'none'; // Hide end early button when paused
        }

        // Complete timer
        function completeTimer() {
            clearInterval(timerInterval);
            isRunning = false;
            startBtn.textContent = 'Start';
            endEarlyBtn.style.display = 'none'; // Hide end early button
            sessionStartTime = null; // Reset session start time

            // Play notification sound (browser notification)
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Pomodoro Timer', {
                    body: `${TIMER_MODES[currentMode].label} completed!`,
                    icon: 'üçÖ'
                });
            }

            // Update stats if it was a pomodoro
            if (currentMode === 'pomodoro') {
                pomodoroCount++;
                totalMinutes += TIMER_MODES[currentMode].duration;
                updateStatsDisplay();
                saveStats();
            }

            // Alert user
            alert(`${TIMER_MODES[currentMode].label} completed!`);

            // Auto-switch to break or back to pomodoro
            if (currentMode === 'pomodoro') {
                switchMode(pomodoroCount % 4 === 0 ? 'long' : 'short');
            } else {
                switchMode('pomodoro');
            }
        }

        // Reset timer
        function resetTimer() {
            clearInterval(timerInterval);
            isRunning = false;
            startBtn.textContent = 'Start';
            endEarlyBtn.style.display = 'none'; // Hide end early button
            sessionStartTime = null; // Reset session start time
            timeLeft = TIMER_MODES[currentMode].duration * 60;
            updateDisplay();
        }

        // End early and add time spent
        function endEarly() {
            if (!isRunning || !sessionStartTime) return;

            // Calculate time spent in seconds
            const timeSpentSeconds = Math.floor((Date.now() - sessionStartTime) / 1000);
            const timeSpentMinutes = Math.round(timeSpentSeconds / 60);

            // Stop the timer
            clearInterval(timerInterval);
            isRunning = false;
            startBtn.textContent = 'Start';
            endEarlyBtn.style.display = 'none';
            sessionStartTime = null;

            // Only add time for pomodoro sessions
            if (currentMode === 'pomodoro' && timeSpentMinutes > 0) {
                totalMinutes += timeSpentMinutes;
                updateStatsDisplay();
                saveStats();

                alert(`Session ended early. Added ${timeSpentMinutes} minute${timeSpentMinutes !== 1 ? 's' : ''} to your total.`);
            } else {
                alert('Session ended.');
            }

            // Reset timer to full duration
            timeLeft = TIMER_MODES[currentMode].duration * 60;
            updateDisplay();
        }

        // Reset stats
        function resetStats() {
            if (confirm('Are you sure you want to reset all statistics? This cannot be undone.')) {
                pomodoroCount = 0;
                totalMinutes = 0;
                updateStatsDisplay();
                saveStats();
            }
        }

        // Switch mode
        function switchMode(mode) {
            if (isRunning) {
                pauseTimer();
            }

            currentMode = mode;
            timeLeft = TIMER_MODES[currentMode].duration * 60;

            // Update active button
            modeButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });

            updateDisplay();
        }

        // Open settings modal
        function openSettings() {
            pomodoroDurationInput.value = TIMER_MODES.pomodoro.duration;
            shortBreakDurationInput.value = TIMER_MODES.short.duration;
            longBreakDurationInput.value = TIMER_MODES.long.duration;
            settingsModal.style.display = 'flex';
        }

        // Close settings modal
        function closeSettings() {
            settingsModal.style.display = 'none';
        }

        // Save settings from modal
        function saveSettingsFromModal() {
            const newPomodoro = parseInt(pomodoroDurationInput.value);
            const newShort = parseInt(shortBreakDurationInput.value);
            const newLong = parseInt(longBreakDurationInput.value);

            if (newPomodoro >= 1 && newPomodoro <= 60 &&
                newShort >= 1 && newShort <= 30 &&
                newLong >= 1 && newLong <= 60) {

                TIMER_MODES.pomodoro.duration = newPomodoro;
                TIMER_MODES.short.duration = newShort;
                TIMER_MODES.long.duration = newLong;

                saveTimerSettings();

                // Reset current timer to new duration
                if (!isRunning) {
                    timeLeft = TIMER_MODES[currentMode].duration * 60;
                    updateDisplay();
                }

                closeSettings();
            } else {
                alert('Please enter valid durations within the allowed ranges.');
            }
        }

        // Request notification permission
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        // Event listeners
        startBtn.addEventListener('click', toggleTimer);
        resetBtn.addEventListener('click', resetTimer);
        resetStatsBtn.addEventListener('click', resetStats);
        endEarlyBtn.addEventListener('click', endEarly);
        settingsBtn.addEventListener('click', openSettings);
        closeModal.addEventListener('click', closeSettings);
        saveSettings.addEventListener('click', saveSettingsFromModal);
        cancelSettings.addEventListener('click', closeSettings);

        // Close modal when clicking outside
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                closeSettings();
            }
        });

        modeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                switchMode(btn.dataset.mode);
            });
        });

        taskInputs.forEach(input => {
            input.addEventListener('input', saveTasks);
            input.addEventListener('blur', saveTasks);
        });

        taskCheckboxes.forEach((checkbox, index) => {
            checkbox.addEventListener('change', () => {
                taskChecked[index] = checkbox.checked;
                saveStats();
                updateTaskHighlight();
                updateDisplay(); // Update timer label if needed
            });
        });

        // Drag and drop functionality
        let draggedElement = null;
        let draggedIndex = null;

        const taskItems = document.querySelectorAll('.task-item');

        taskItems.forEach((item, index) => {
            item.addEventListener('dragstart', (e) => {
                draggedElement = item;
                draggedIndex = index;
                item.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });

            item.addEventListener('dragend', (e) => {
                item.classList.remove('dragging');
                draggedElement = null;
                draggedIndex = null;
            });

            item.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';

                if (draggedElement && draggedElement !== item) {
                    const taskList = item.parentNode;
                    const allItems = [...taskList.querySelectorAll('.task-item')];
                    const draggedIdx = allItems.indexOf(draggedElement);
                    const targetIdx = allItems.indexOf(item);

                    if (draggedIdx < targetIdx) {
                        item.parentNode.insertBefore(draggedElement, item.nextSibling);
                    } else {
                        item.parentNode.insertBefore(draggedElement, item);
                    }
                }
            });

            item.addEventListener('drop', (e) => {
                e.preventDefault();
                if (draggedElement && draggedElement !== item) {
                    // Get current order from DOM
                    const taskList = document.querySelector('.task-list');
                    const allItems = [...taskList.querySelectorAll('.task-item')];

                    // Create new arrays based on DOM order
                    const newTasks = [];
                    const newTaskChecked = [];

                    allItems.forEach((taskItem) => {
                        const oldIndex = parseInt(taskItem.dataset.index);
                        newTasks.push(tasks[oldIndex]);
                        newTaskChecked.push(taskChecked[oldIndex]);
                    });

                    // Update state
                    tasks = newTasks;
                    taskChecked = newTaskChecked;

                    // Update data-index attributes
                    allItems.forEach((taskItem, newIndex) => {
                        taskItem.dataset.index = newIndex;
                    });

                    // Save and update display
                    saveStats();
                    updateTaskHighlight();
                    updateDisplay();
                }
            });
        });

        // Initialize
        loadTimerSettings();
        loadStats();
        updateDisplay();
        requestNotificationPermission();
    </script>
</body>

</html>